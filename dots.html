<html>
    <!--
        Todo:
            Stop/continue functionality
            Zoom
            Add different generators
            Allow entry of numerical parameters
            Parameters on URL
    -->
    <head><title>dots</title>
<style>
    .stack { display: grid;
             grid-template-rows: 1fr minmax(100px, auto);
             grid-template-columns: 1fr;
             width: 100vw;
             height: 100vh; }
    .row1 { overflow: hidden; }
    .row2 { }
    form { display: table; width: 90%; padding: 10px; }
    form p { display: table-row; }
    form label { display: table-cell; text-align: right; width: 1%; }
    form input { display: table-cell; width: 95%;}
    form span { display: table-cell; width: 1%;}
    canvas { width: 100%; height: 100%; }
</style>
<script>
var width = 800;
var height = 600;
var marg = 10;
var canvas, ctx;
function getvalue(s) {
    r = +document.getElementById(s).value;
    document.getElementById("show"+s).innerText = r;
    return r;
}
function drawcirc(ctx, x, y, r) {
    ctx.beginPath();
    ctx.arc(x, y, r, 0, 2*Math.PI, false);
    ctx.stroke();
}
var ar, br, an, bn, sep, ax, ay, bx, by, sc;
var deepest = 0;
var renderlim = 300;
var pallete = [];
var eps = 1e-9;
var san, can, sbn, cbn, pts, ox, oy, ord, p, drawit, delta, mindist, incirc, x, y, ii, state=0;
var stopped = true;
var stoptime;
function doanim() {
    width = canvas.clientWidth;
    height = canvas.clientHeight;
    canvas.width = width;
    canvas.height = height;
    ar = getvalue("arad");
    br = getvalue("brad");
    an = getvalue("an");
    bn = getvalue("bn");
    sep = getvalue("dist");
    var h = Math.max(ar, br) * 2;
    var w = ar + br + sep;
    sc = Math.min((height-2*marg)/h, (width-2*marg)/w);
    ay = height / 2;
    ax = width / 2 - 0.5 * (sep + br - ar) * sc;
    ax = Math.floor(ax) + 0.5;
    ay = Math.floor(ay) + 0.5;
    by = ay;
    bx = ax + sep * sc;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawcirc(ctx, ax, ay, ar * sc);
    drawcirc(ctx, bx, by, br * sc);
    deepest = 0;
    renderlim = 300;
    state = 0;
    stoptime = performance.now() + 1000 * 60; // stop after 10s
    if (stopped) {
        stopped = false;
        requestAnimationFrame(dowork);
    }
    return false; // suppress submit
}
// state 0: pick a new point and initialize
// state 1: chase through points, and accumulate
// state 2: render
var timelim = 13; // max work milliseconds per anim call
var h1=0;
var h2=0;
var h3=0;
function dowork() {
    var start = performance.now();
    if (start > stoptime) {
        stopped = true;
    } else {
        requestAnimationFrame(dowork);
    }
    while (1) {
        if (state == 0) {
            while (1) {
                x = (2 * Math.random() - 1);
                y = (2 * Math.random() - 1);
                if (Math.hypot(x, y) < 1) {
                    if (Math.random() < 0.5) {
                        x = ar*x;
                        y = ar*y;
                    } else {
                        x = br*x+sep;
                        y = br*y;
                    }
                    break;
                }
            }
            san = Math.sin(Math.PI * 2 / an);
            can = Math.cos(Math.PI * 2 / an);
            sbn = -Math.sin(Math.PI * 2 / bn);
            cbn = Math.cos(Math.PI * 2 / bn);
            pts = [];
            ox = x;
            oy = y;
            ord = 0;
            p = [];
            drawit = false;
            delta = 1;
            mindist = 1000;
            incirc = false;
            state = 1;
            ii = 0;
        }
        if (state == 1) {
            for (; ii<renderlim; ii++) {
                if ((ii & 8191) == 0 && performance.now() - start > timelim) {
                    return;
                }
                var t = Math.hypot(x, y) - ar;
                mindist = Math.min(Math.abs(t), mindist);
                if (t <= 0) {
                    incirc = true;
                    var nx = x * can + y * san;
                    y = y * can - x * san;
                    x = nx;
                }
                x -= sep;
                var t = Math.hypot(x, y) - br;
                mindist = Math.min(Math.abs(t), mindist);
                if (t <= 0) {
                    incirc = true;
                    var nx = x * cbn + y * sbn;
                    y = y * cbn - x * sbn;
                    x = nx;
                }
                p.push((x + sep) * sc + ax, y * sc + ay);
                ord++;
                if (Math.hypot(x+sep-ox, y-oy) < eps) {
                    delta = Math.hypot(x+sep-ox, y-oy);
                    drawit = true;
                    break;
                }
                x += sep;
            }
            mindist *= sc;
            if (!drawit && renderlim < 1000000) {
                deepest = renderlim;
                document.getElementById("order").innerText = ">" + deepest;
                renderlim = Math.floor(renderlim * 1.1);
            }
            if (!incirc || !drawit) {
                state = 0;
            } else {
                state = 2;
                ii = 0;
            }
        }
        if (state == 2) {
            if (ord > deepest) {
                deepest = ord;
                document.getElementById("order").innerText = deepest;
            }
            if (!pallete[ord]) {
                var cr = ord * 154 % 251;
                var cg = ord * 230 % 241;
                var cb = ord * 214 % 239;
                pallete[ord] = "rgb(" + cr + "," + cg + "," + cb + ")";
            }
            ctx.fillStyle = pallete[ord];
            if (mindist < 2) {
                for (; ii<p.length; ii += 2) {
                    if ((ii & 8191) == 0 && performance.now() - start > timelim) {
                        return;
                    }
                    ctx.fillRect(p[ii], p[ii+1], 1, 1);
                }
            } else {
                for (; ii<p.length; ii += 2) {
                    if ((ii & 8191) == 0 && performance.now() - start > timelim) {
                        return;
                    }
                    ctx.beginPath();
                    ctx.arc(p[ii], p[ii+1], mindist-0.5, 0, 2*Math.PI, false);
                    ctx.fill();
                }
            }
            state = 0;
        }
    }
}
function start() {
    canvas = document.getElementById("canvas");
    ctx = canvas.getContext("2d");
    document.getElementById("arad").oninput = doanim;
    document.getElementById("brad").oninput = doanim;
    document.getElementById("an").oninput = doanim;
    document.getElementById("bn").oninput = doanim;
    document.getElementById("dist").oninput = doanim;
    window.onresize = doanim;
    doanim();
}
</script>
    </head>
    <body onload="start();"><div class="stack"><div class="row1"><canvas id="canvas" width="80" height="80"></canvas></div>
    <div class="row2"><form>
        <p><label for="arad">Radius A&nbsp;</label><input id="arad" type="range" step="0.001" min="1" max="10" value="2.41"><span id="showarad"></span></p>
        <p><label for="an">Spin A&nbsp;</label><input id="an" type="range" step="1" min="2" max="20" value="3"><span id="showan"></span></p>
        <p><label for="brad">Radius B&nbsp;</label><input id="brad" type="range" step="0.001" min="1" max="10" value="2.42"><span id="showbrad"></span></p>
        <p><label for="bn">Spin B&nbsp;</label><input id="bn" type="range" step="1" min="2" max="20" value="5"><span id="showbn"></span></p>
        <p><label for="dist">Separation&nbsp;</label><input id="dist" min="0" step="0.001" max="10" type="range" value="2"><span id="showdist"></span></p>
    </form>
    Maximum order found: <span id="order"></span>
    </div></div>
    </body>
</html>